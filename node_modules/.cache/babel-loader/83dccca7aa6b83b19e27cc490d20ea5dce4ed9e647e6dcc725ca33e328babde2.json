{"ast":null,"code":"import dayjs from \"dayjs\";\n$(function () {\n  var sessionTimeOutEnabled = true;\n  var $timeoutModal = $(\"#timeoutModal\");\n  var timeoutInSeconds = parseInt($timeoutModal.data(\"session-timeout\"), 10);\n  var secondsUntilTimeoutPath = $timeoutModal.data(\"seconds-until-timeout-path\");\n  var heartbeatPath = $timeoutModal.data(\"heartbeat-path\");\n  var interval = parseInt($timeoutModal.data(\"session-timeout-interval\"), 10);\n  var preventTimeOutSeconds = $timeoutModal.data(\"prevent-timeout-seconds\");\n  var endsAt = dayjs().add(timeoutInSeconds, \"seconds\");\n  var lastAction = dayjs();\n  var $continueSessionButton = $(\"#continueSession\");\n  var lastActivityCheck = dayjs();\n  // 5 * 60 seconds = 5 Minutes\n  var activityCheckInterval = 5 * 60;\n  var preventTimeOutUntil = dayjs().add(preventTimeOutSeconds, \"seconds\");\n\n  // Ajax request is made at timeout_modal.html.erb\n  $continueSessionButton.on(\"click\", function () {\n    $timeoutModal.foundation(\"close\");\n    // In admin panel we have to hide all overlays\n    $(\".reveal-overlay\").css(\"display\", \"none\");\n    lastActivityCheck = dayjs();\n  });\n  if (isNaN(interval)) {\n    return;\n  }\n  if (!timeoutInSeconds) {\n    return;\n  }\n  var disableSessionTimeout = function disableSessionTimeout() {\n    sessionTimeOutEnabled = false;\n  };\n  var enableSessionTimeout = function enableSessionTimeout() {\n    sessionTimeOutEnabled = true;\n  };\n  var setTimer = function setTimer(secondsUntilExpiration) {\n    if (!secondsUntilExpiration) {\n      return;\n    }\n    endsAt = dayjs().add(secondsUntilExpiration, \"seconds\");\n  };\n  var sessionTimeLeft = function sessionTimeLeft() {\n    return $.ajax({\n      method: \"GET\",\n      url: secondsUntilTimeoutPath,\n      contentType: \"application/json\",\n      headers: {\n        \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n      }\n    });\n  };\n  var heartbeat = function heartbeat() {\n    return $.ajax({\n      method: \"POST\",\n      url: heartbeatPath,\n      contentType: \"application/javascript\"\n    });\n  };\n  var userBeenActiveSince = function userBeenActiveSince(seconds) {\n    return (dayjs() - lastAction) / 1000 < seconds;\n  };\n  var exitInterval = setInterval(function () {\n    var timeSinceLastActivityCheckInSeconds = Math.round((dayjs() - lastActivityCheck) / 1000);\n    var popupOpen = $(\"#timeoutModal\").parent().css(\"display\") === \"block\";\n    if (!popupOpen && timeSinceLastActivityCheckInSeconds >= activityCheckInterval) {\n      lastActivityCheck = dayjs();\n      if (userBeenActiveSince(activityCheckInterval)) {\n        heartbeat();\n        return;\n      }\n    }\n    var timeRemaining = Math.round((endsAt - dayjs()) / 1000);\n    if (timeRemaining > 170) {\n      return;\n    }\n    if (dayjs() < preventTimeOutUntil) {\n      heartbeat();\n      return;\n    }\n    sessionTimeLeft().then(function (result) {\n      var secondsUntilSessionExpires = result.seconds_remaining;\n      setTimer(secondsUntilSessionExpires);\n      if (!sessionTimeOutEnabled) {\n        heartbeat();\n      } else if (secondsUntilSessionExpires <= 90) {\n        $timeoutModal.find(\"#reveal-hidden-sign-out\")[0].click();\n      } else if (secondsUntilSessionExpires <= 150) {\n        $timeoutModal.foundation(\"open\");\n      }\n    });\n  }, interval);\n  $(document).mousemove(function () {\n    lastAction = dayjs();\n  });\n  $(document).scroll(function () {\n    lastAction = dayjs();\n  });\n  $(document).keypress(function () {\n    lastAction = dayjs();\n  });\n\n  // Devise restarts its own timer on ajax requests,\n  // so here we restart our.\n  $(document).on(\"ajax:complete\", function () {\n    setTimer(timeoutInSeconds);\n  });\n  $(document).ajaxComplete(function (_event, _xhr, settings) {\n    if (settings && settings.url === secondsUntilTimeoutPath) {\n      return;\n    }\n    setTimer(timeoutInSeconds);\n  });\n  window.addEventListener(\"beforeunload\", function () {\n    clearInterval(exitInterval);\n    return;\n  });\n  window.Decidim.enableSessionTimeout = enableSessionTimeout;\n  window.Decidim.disableSessionTimeout = disableSessionTimeout;\n});","map":{"version":3,"names":["dayjs","$","sessionTimeOutEnabled","$timeoutModal","timeoutInSeconds","parseInt","data","secondsUntilTimeoutPath","heartbeatPath","interval","preventTimeOutSeconds","endsAt","add","lastAction","$continueSessionButton","lastActivityCheck","activityCheckInterval","preventTimeOutUntil","on","foundation","css","isNaN","disableSessionTimeout","enableSessionTimeout","setTimer","secondsUntilExpiration","sessionTimeLeft","ajax","method","url","contentType","headers","attr","heartbeat","userBeenActiveSince","seconds","exitInterval","setInterval","timeSinceLastActivityCheckInSeconds","Math","round","popupOpen","parent","timeRemaining","then","result","secondsUntilSessionExpires","seconds_remaining","find","click","document","mousemove","scroll","keypress","ajaxComplete","_event","_xhr","settings","window","addEventListener","clearInterval","Decidim"],"sources":["/home/nico/.rbenv/versions/3.0.2/lib/ruby/gems/3.0.0/gems/decidim-core-0.27.3/app/packs/src/decidim/session_timeouter.js"],"sourcesContent":["import dayjs from \"dayjs\"\n\n$(() => {\n  let sessionTimeOutEnabled = true;\n  const $timeoutModal = $(\"#timeoutModal\");\n  const timeoutInSeconds = parseInt($timeoutModal.data(\"session-timeout\"), 10);\n  const secondsUntilTimeoutPath = $timeoutModal.data(\"seconds-until-timeout-path\");\n  const heartbeatPath = $timeoutModal.data(\"heartbeat-path\");\n  const interval = parseInt($timeoutModal.data(\"session-timeout-interval\"), 10);\n  const preventTimeOutSeconds = $timeoutModal.data(\"prevent-timeout-seconds\");\n  let endsAt = dayjs().add(timeoutInSeconds, \"seconds\");\n  let lastAction = dayjs();\n  const $continueSessionButton = $(\"#continueSession\");\n  let lastActivityCheck = dayjs();\n  // 5 * 60 seconds = 5 Minutes\n  const activityCheckInterval = 5 * 60;\n  const preventTimeOutUntil = dayjs().add(preventTimeOutSeconds, \"seconds\");\n\n  // Ajax request is made at timeout_modal.html.erb\n  $continueSessionButton.on(\"click\", () => {\n    $timeoutModal.foundation(\"close\");\n    // In admin panel we have to hide all overlays\n    $(\".reveal-overlay\").css(\"display\", \"none\");\n    lastActivityCheck = dayjs();\n  })\n\n  if (isNaN(interval)) {\n    return;\n  }\n  if (!timeoutInSeconds) {\n    return;\n  }\n\n  const disableSessionTimeout = () => {\n    sessionTimeOutEnabled = false;\n  }\n\n  const enableSessionTimeout = () => {\n    sessionTimeOutEnabled = true;\n  }\n\n  const setTimer = (secondsUntilExpiration) => {\n    if (!secondsUntilExpiration) {\n      return;\n    }\n    endsAt = dayjs().add(secondsUntilExpiration, \"seconds\");\n  }\n\n  const sessionTimeLeft = () => {\n    return $.ajax({\n      method: \"GET\",\n      url: secondsUntilTimeoutPath,\n      contentType: \"application/json\",\n      headers: {\n        \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")\n      }\n    });\n  }\n\n  const heartbeat = () => {\n    return $.ajax({\n      method: \"POST\",\n      url: heartbeatPath,\n      contentType: \"application/javascript\"\n    });\n  }\n\n  const userBeenActiveSince = (seconds) => {\n    return (dayjs() - lastAction) / 1000 < seconds;\n  }\n\n  const exitInterval = setInterval(() => {\n    const timeSinceLastActivityCheckInSeconds = Math.round((dayjs() - lastActivityCheck) / 1000);\n\n    const popupOpen = $(\"#timeoutModal\").parent().css(\"display\") === \"block\";\n    if (!popupOpen && timeSinceLastActivityCheckInSeconds >= activityCheckInterval) {\n      lastActivityCheck = dayjs();\n      if (userBeenActiveSince(activityCheckInterval)) {\n        heartbeat();\n        return;\n      }\n    }\n\n    const timeRemaining = Math.round((endsAt - dayjs()) / 1000);\n    if (timeRemaining > 170) {\n      return;\n    }\n\n    if (dayjs() < preventTimeOutUntil) {\n      heartbeat();\n      return;\n    }\n\n    sessionTimeLeft().then((result) => {\n      const secondsUntilSessionExpires = result.seconds_remaining;\n      setTimer(secondsUntilSessionExpires);\n\n      if (!sessionTimeOutEnabled) {\n        heartbeat();\n      } else if (secondsUntilSessionExpires <= 90) {\n        $timeoutModal.find(\"#reveal-hidden-sign-out\")[0].click();\n      } else if (secondsUntilSessionExpires <= 150) {\n        $timeoutModal.foundation(\"open\");\n      }\n    });\n  }, interval);\n\n  $(document).mousemove(() => {\n    lastAction = dayjs();\n  })\n  $(document).scroll(() => {\n    lastAction = dayjs();\n  })\n  $(document).keypress(() => {\n    lastAction = dayjs();\n  })\n\n  // Devise restarts its own timer on ajax requests,\n  // so here we restart our.\n  $(document).on(\"ajax:complete\", () => {\n    setTimer(timeoutInSeconds);\n  });\n\n  $(document).ajaxComplete((_event, _xhr, settings) => {\n    if (settings && settings.url === secondsUntilTimeoutPath) {\n      return;\n    }\n    setTimer(timeoutInSeconds);\n  });\n\n  window.addEventListener(\"beforeunload\", () => {\n    clearInterval(exitInterval);\n    return;\n  });\n\n  window.Decidim.enableSessionTimeout = enableSessionTimeout\n  window.Decidim.disableSessionTimeout = disableSessionTimeout\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}